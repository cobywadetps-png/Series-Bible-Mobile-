<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Series Bible (Mobile)</title>
  <style>
    :root { --pad: 14px; --radius: 12px; --border: #e6e6e6; }
    body { margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; background:#fafafa; }
    header { padding: var(--pad); background:#fff; border-bottom:1px solid var(--border); position: sticky; top:0; z-index: 5; }
    header h1 { margin: 0; font-size: 18px; }
    header .sub { margin-top: 6px; display:flex; gap:10px; flex-wrap:wrap; }
    .pill { font-size: 12px; padding: 6px 10px; border:1px solid var(--border); border-radius: 999px; background:#fff; }
    main { padding: var(--pad); padding-bottom: 86px; }
    .card { background:#fff; border:1px solid var(--border); border-radius: var(--radius); padding: var(--pad); margin-bottom: 12px; }
    .row { display:flex; gap:10px; }
    .row > * { flex: 1; }
    label { display:block; font-size: 12px; margin: 10px 0 6px; color:#333; }
    input, select, textarea, button {
      width: 100%; box-sizing: border-box; font-size: 16px;
      padding: 10px 12px; border-radius: 10px; border:1px solid var(--border); background:#fff;
    }
    textarea { min-height: 84px; resize: vertical; }
    button { border: 1px solid #111; background:#111; color:#fff; font-weight: 600; }
    button.ghost { background:#fff; color:#111; }
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0;
      display:flex; gap: 6px; padding: 10px; background:#fff; border-top:1px solid var(--border);
    }
    .tab { flex:1; padding: 10px 8px; font-size: 12px; border:1px solid var(--border); border-radius: 12px; background:#fff; }
    .tab.active { border-color:#111; }
    .list { margin-top: 10px; display:flex; flex-direction:column; gap:8px; }
    .item { padding: 10px; border:1px solid var(--border); border-radius: 12px; background:#fff; }
    .item .top { display:flex; justify-content:space-between; gap:10px; }
    .item .title { font-weight:700; }
    .item .meta { font-size: 12px; color:#555; margin-top: 6px; }
    .item .actions { display:flex; gap:8px; margin-top: 10px; }
    .item .actions button { padding: 8px 10px; font-size: 13px; }
    .small { font-size: 12px; color:#555; }
    .muted { color:#777; }
    .checkboxes { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .check { display:flex; align-items:center; gap:10px; }
    .check input { width: 18px; height: 18px; }
    .hr { height:1px; background: var(--border); margin: 14px 0; }
  </style>
</head>
<body>
  <header>
    <h1 id="appTitle">Series Bible (Mobile)</h1>
    <div class="sub">
      <div class="pill" id="countPill">Loading…</div>
      <div class="pill">Offline-ready</div>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="view-home" class="view">
      <div class="card">
        <label>Search everything</label>
        <input id="globalSearch" placeholder="Search characters, places, scenes, threads…" />
        <div class="small muted" style="margin-top:8px;">
          Tip: Keep this app as your quick capture tool while drafting.
        </div>
      </div>

      <div class="card">
        <div class="row">
          <button onclick="setTab('characters')">➕ Character</button>
          <button onclick="setTab('scenes')">➕ Scene</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button onclick="setTab('locations')" class="ghost">➕ Location</button>
          <button onclick="setTab('threads')" class="ghost">➕ Thread</button>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong>Open Threads (Top 10)</strong>
          <span class="small muted">by priority</span>
        </div>
        <div class="list" id="openThreadsList"></div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <strong>Scenes In Progress (Top 10)</strong>
          <span class="small muted">Outline/Draft</span>
        </div>
        <div class="list" id="inProgressScenesList"></div>
      </div>
    </section>

    <!-- CHARACTERS -->
    <section id="view-characters" class="view" style="display:none;">
      <div class="card">
        <strong>Add Character</strong>
        <label>Name</label>
        <input id="c_name" placeholder="e.g., Keira Vale" />
        <div class="row">
          <div>
            <label>Role</label>
            <select id="c_role">
              <option>Main</option><option>Supporting</option><option>Minor</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="c_status">
              <option>Active</option><option>Dormant</option><option>Dead</option><option>Unknown</option>
            </select>
          </div>
        </div>
        <label>Books (comma separated)</label>
        <input id="c_books" placeholder="Book 1, Book 2" />
        <label>Notes</label>
        <textarea id="c_notes" placeholder="Voice, goals, backstory, canon facts…"></textarea>
        <div class="row">
          <button onclick="addCharacter()">Save Character</button>
          <button class="ghost" onclick="clearCharacterForm()">Clear</button>
        </div>
      </div>

      <div class="card">
        <strong>Characters</strong>
        <label>Filter</label>
        <input id="c_filter" placeholder="Type to filter…" />
        <div class="list" id="charactersList"></div>
      </div>
    </section>

    <!-- LOCATIONS -->
    <section id="view-locations" class="view" style="display:none;">
      <div class="card">
        <strong>Add Location</strong>
        <label>Name</label>
        <input id="l_name" placeholder="e.g., Nyx’s Temple" />
        <div class="row">
          <div>
            <label>Type</label>
            <select id="l_type">
              <option>City/Town</option><option>Building</option><option>Realm</option><option>Wilderness</option><option>Other</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="l_status">
              <option>Active</option><option>One-off</option><option>Retired</option>
            </select>
          </div>
        </div>
        <label>Rules / Constraints</label>
        <input id="l_rules" placeholder="e.g., No tech works, always raining…" />
        <label>Notes</label>
        <textarea id="l_notes" placeholder="Details, vibe, map notes…"></textarea>
        <div class="row">
          <button onclick="addLocation()">Save Location</button>
          <button class="ghost" onclick="clearLocationForm()">Clear</button>
        </div>
      </div>

      <div class="card">
        <strong>Locations</strong>
        <label>Filter</label>
        <input id="l_filter" placeholder="Type to filter…" />
        <div class="list" id="locationsList"></div>
      </div>
    </section>

    <!-- THREADS -->
    <section id="view-threads" class="view" style="display:none;">
      <div class="card">
        <strong>Add Thread</strong>
        <label>Thread</label>
        <input id="t_title" placeholder="e.g., Who is the green-eyed man?" />
        <div class="row">
          <div>
            <label>Type</label>
            <select id="t_type">
              <option>Mystery</option><option>Promise</option><option>Foreshadow</option><option>Relationship</option><option>Plot</option><option>Worldbuilding</option>
            </select>
          </div>
          <div>
            <label>Priority</label>
            <select id="t_priority">
              <option>High</option><option>Medium</option><option>Low</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Status</label>
            <select id="t_status">
              <option>Open</option><option>In Progress</option><option>Resolved</option><option>Cut</option>
            </select>
          </div>
          <div>
            <label>Books</label>
            <input id="t_books" placeholder="Book 1, Book 2" />
          </div>
        </div>
        <label>Summary</label>
        <textarea id="t_summary" placeholder="What’s the setup, and what must pay off?"></textarea>
        <div class="row">
          <button onclick="addThread()">Save Thread</button>
          <button class="ghost" onclick="clearThreadForm()">Clear</button>
        </div>
      </div>

      <div class="card">
        <strong>Threads</strong>
        <label>Filter</label>
        <input id="t_filter" placeholder="Type to filter…" />
        <div class="list" id="threadsList"></div>
      </div>
    </section>

    <!-- SCENES -->
    <section id="view-scenes" class="view" style="display:none;">
      <div class="card">
        <strong>Add Scene / Chapter</strong>
        <div class="row">
          <div>
            <label>Book</label>
            <input id="s_book" placeholder="Book 1" />
          </div>
          <div>
            <label>Chapter #</label>
            <input id="s_chapter" type="number" placeholder="3" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Status</label>
            <select id="s_status">
              <option>Outline</option><option>Draft</option><option>Revised</option><option>Final</option>
            </select>
          </div>
          <div>
            <label>POV</label>
            <input id="s_pov" placeholder="e.g., Keira" />
          </div>
        </div>

        <label>Setting (pick a Location)</label>
        <select id="s_setting"></select>

        <label>Characters in Scene</label>
        <div class="checkboxes" id="s_chars"></div>

        <label>Threads touched</label>
        <div class="checkboxes" id="s_threads"></div>

        <label>Key Beats</label>
        <textarea id="s_beats" placeholder="What happens? What changes?"></textarea>

        <label>Continuity Flags</label>
        <input id="s_flags" placeholder="Fact check, timeline, magic, relationship…" />

        <div class="row">
          <button onclick="addScene()">Save Scene</button>
          <button class="ghost" onclick="clearSceneForm()">Clear</button>
        </div>
      </div>

      <div class="card">
        <strong>Scenes</strong>
        <label>Filter</label>
        <input id="s_filter" placeholder="Search book/chapter/POV/beats…" />
        <div class="list" id="scenesList"></div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="view-backup" class="view" style="display:none;">
      <div class="card">
        <strong>Backup & Restore</strong>
        <div class="small muted" style="margin-top:6px;">
          Export makes a JSON file you can save in the Files app. Import restores it.
        </div>
        <div class="hr"></div>
        <button onclick="exportData()">Export Data (.json)</button>
        <div style="height:10px"></div>
        <input id="importFile" type="file" accept="application/json" />
        <div style="height:10px"></div>
        <button class="ghost" onclick="importData()">Import Data</button>
        <div class="hr"></div>
        <button class="ghost" onclick="resetAll()" style="border-color:#b00020; color:#b00020;">Reset Everything</button>
      </div>
    </section>
  </main>

  <div class="tabs">
    <button class="tab active" id="tab-home" onclick="setTab('home')">Home</button>
    <button class="tab" id="tab-characters" onclick="setTab('characters')">Characters</button>
    <button class="tab" id="tab-scenes" onclick="setTab('scenes')">Scenes</button>
    <button class="tab" id="tab-threads" onclick="setTab('threads')">Threads</button>
    <button class="tab" id="tab-backup" onclick="setTab('backup')">Backup</button>
  </div>

<script>
  const KEY = "series_bible_mobile_v1";
  const uid = () => Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
  const load = () => JSON.parse(localStorage.getItem(KEY) || '{"characters":[],"locations":[],"threads":[],"scenes":[]}');
  const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

  let state = load();

  function setTab(name){
    document.querySelectorAll(".view").forEach(v => v.style.display = "none");
    document.getElementById("view-" + name).style.display = "";
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById("tab-" + name).classList.add("active");
    if(name === "scenes") refreshScenePickers();
    renderAll();
  }

  function renderAll(){
    // counts
    document.getElementById("countPill").textContent =
      `${state.characters.length} chars • ${state.locations.length} locs • ${state.scenes.length} scenes • ${state.threads.length} threads`;

    // home: open threads
    const priRank = {High: 0, Medium: 1, Low: 2};
    const openThreads = state.threads
      .filter(t => (t.status || "Open") === "Open")
      .sort((a,b)=> (priRank[a.priority||"Medium"] ?? 9) - (priRank[b.priority||"Medium"] ?? 9))
      .slice(0,10);
    renderList("openThreadsList", openThreads, (t)=> `${t.title}`, (t)=> `${t.type||""} • ${t.priority||""}`);

    // home: in progress scenes
    const inProg = state.scenes
      .filter(s => ["Outline","Draft"].includes(s.status||"Outline"))
      .sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0))
      .slice(0,10);
    renderList("inProgressScenesList", inProg, (s)=> `${s.book||"Book?"} Ch ${s.chapter||"?"}`, (s)=> `${s.pov||""} • ${s.status||""}`);

    // filters
    const cQ = (document.getElementById("c_filter").value || "").toLowerCase();
    const lQ = (document.getElementById("l_filter").value || "").toLowerCase();
    const tQ = (document.getElementById("t_filter").value || "").toLowerCase();
    const sQ = (document.getElementById("s_filter").value || "").toLowerCase();

    const chars = state.characters.filter(c => (c.name||"").toLowerCase().includes(cQ));
    renderCRUD("charactersList", chars, "character");

    const locs = state.locations.filter(l => (l.name||"").toLowerCase().includes(lQ));
    renderCRUD("locationsList", locs, "location");

    const ths = state.threads.filter(t =>
      ((t.title||"").toLowerCase().includes(tQ)) || ((t.summary||"").toLowerCase().includes(tQ))
    );
    renderCRUD("threadsList", ths, "thread");

    const scs = state.scenes.filter(s =>
      ((s.book||"").toLowerCase().includes(sQ)) ||
      ((String(s.chapter||"")).toLowerCase().includes(sQ)) ||
      ((s.pov||"").toLowerCase().includes(sQ)) ||
      ((s.beats||"").toLowerCase().includes(sQ))
    );
    renderCRUD("scenesList", scs, "scene");
  }

  function renderList(containerId, items, titleFn, metaFn){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    if(items.length === 0){
      el.innerHTML = `<div class="small muted">Nothing here yet.</div>`;
      return;
    }
    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="top"><div class="title">${escapeHtml(titleFn(it))}</div></div>
        <div class="meta">${escapeHtml(metaFn(it))}</div>
      `;
      el.appendChild(div);
    });
  }

  function renderCRUD(containerId, items, kind){
    const el = document.getElementById(containerId);
    el.innerHTML = "";
    if(items.length === 0){
      el.innerHTML = `<div class="small muted">No results.</div>`;
      return;
    }
    items
      .sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0))
      .forEach(it => {
        const div = document.createElement("div");
        div.className = "item";
        const meta = buildMeta(it, kind);
        div.innerHTML = `
          <div class="top">
            <div class="title">${escapeHtml(it.name || it.title || (it.book ? `${it.book} Ch ${it.chapter||"?"}` : "Untitled"))}</div>
            <div class="small muted">${new Date(it.updatedAt||Date.now()).toLocaleDateString()}</div>
          </div>
          <div class="meta">${escapeHtml(meta)}</div>
          <div class="actions">
            <button class="ghost" onclick="removeItem('${kind}','${it.id}')">Delete</button>
          </div>
        `;
        el.appendChild(div);
      });
  }

  function buildMeta(it, kind){
    if(kind === "character") return `${it.role||""} • ${it.status||""} • ${it.books||""}`;
    if(kind === "location") return `${it.type||""} • ${it.status||""} • ${it.rules||""}`;
    if(kind === "thread") return `${it.type||""} • ${it.priority||""} • ${it.status||""} • ${it.books||""}`;
    if(kind === "scene") return `${it.book||""} • Ch ${it.chapter||""} • ${it.pov||""} • ${it.status||""}`;
    return "";
  }

  function addCharacter(){
    const name = val("c_name"); if(!name) return alert("Name required.");
    state.characters.push({
      id: uid(), name,
      role: val("c_role"), status: val("c_status"),
      books: val("c_books"), notes: val("c_notes"),
      updatedAt: Date.now()
    });
    persist();
    clearCharacterForm();
  }
  function clearCharacterForm(){ set("c_name",""); set("c_books",""); set("c_notes",""); }

  function addLocation(){
    const name = val("l_name"); if(!name) return alert("Name required.");
    state.locations.push({
      id: uid(), name,
      type: val("l_type"), status: val("l_status"),
      rules: val("l_rules"), notes: val("l_notes"),
      updatedAt: Date.now()
    });
    persist();
    clearLocationForm();
  }
  function clearLocationForm(){ set("l_name",""); set("l_rules",""); set("l_notes",""); }

  function addThread(){
    const title = val("t_title"); if(!title) return alert("Thread required.");
    state.threads.push({
      id: uid(), title,
      type: val("t_type"), priority: val("t_priority"),
      status: val("t_status"), books: val("t_books"),
      summary: val("t_summary"),
      updatedAt: Date.now()
    });
    persist();
    clearThreadForm();
  }
  function clearThreadForm(){ set("t_title",""); set("t_books",""); set("t_summary",""); }

  function refreshScenePickers(){
    // setting dropdown
    const setting = document.getElementById("s_setting");
    setting.innerHTML = `<option value="">(No setting yet)</option>`;
    state.locations
      .slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""))
      .forEach(l => {
        const o = document.createElement("option");
        o.value = l.id; o.textContent = l.name;
        setting.appendChild(o);
      });

    // characters checkboxes
    const chars = document.getElementById("s_chars");
    chars.innerHTML = "";
    state.characters
      .slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""))
      .forEach(c => {
        const row = document.createElement("label");
        row.className = "check";
        row.innerHTML = `<input type="checkbox" value="${c.id}" /> <span>${escapeHtml(c.name)}</span>`;
        chars.appendChild(row);
      });

    // threads checkboxes
    const threads = document.getElementById("s_threads");
    threads.innerHTML = "";
    state.threads
      .slice().sort((a,b)=> (a.title||"").localeCompare(b.title||""))
      .forEach(t => {
        const row = document.createElement("label");
        row.className = "check";
        row.innerHTML = `<input type="checkbox" value="${t.id}" /> <span>${escapeHtml(t.title)}</span>`;
        threads.appendChild(row);
      });
  }

  function addScene(){
    const book = val("s_book").trim() || "Book 1";
    const chapter = Number(val("s_chapter") || 0) || "";
    const status = val("s_status");
    const pov = val("s_pov");
    const settingId = val("s_setting") || "";
    const beats = val("s_beats");
    const flags = val("s_flags");

    const charIds = [...document.querySelectorAll("#s_chars input:checked")].map(x=>x.value);
    const threadIds = [...document.querySelectorAll("#s_threads input:checked")].map(x=>x.value);

    state.scenes.push({
      id: uid(), book, chapter, status, pov,
      settingId, charIds, threadIds,
      beats, flags,
      updatedAt: Date.now()
    });
    persist();
    clearSceneForm();
  }

  function clearSceneForm(){
    set("s_book","Book 1"); set("s_chapter",""); set("s_pov","");
    set("s_beats",""); set("s_flags","");
    const setting = document.getElementById("s_setting"); if(setting) setting.value = "";
    document.querySelectorAll("#s_chars input").forEach(x=>x.checked=false);
    document.querySelectorAll("#s_threads input").forEach(x=>x.checked=false);
  }

  function removeItem(kind, id){
    if(!confirm("Delete this item?")) return;
    if(kind==="character") state.characters = state.characters.filter(x=>x.id!==id);
    if(kind==="location") state.locations = state.locations.filter(x=>x.id!==id);
    if(kind==="thread") state.threads = state.threads.filter(x=>x.id!==id);
    if(kind==="scene") state.scenes = state.scenes.filter(x=>x.id!==id);
    // clean references from scenes
    state.scenes.forEach(s=>{
      if(s.settingId===id) s.settingId="";
      s.charIds = (s.charIds||[]).filter(cid=>cid!==id);
      s.threadIds = (s.threadIds||[]).filter(tid=>tid!==id);
    });
    persist();
  }

  function exportData(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "series-bible-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function importData(){
    const f = document.getElementById("importFile").files[0];
    if(!f) return alert("Choose a .json file first.");
    const r = new FileReader();
    r.onload = () => {
      try{
        const obj = JSON.parse(r.result);
        if(!obj.characters || !obj.locations || !obj.threads || !obj.scenes) throw new Error("Bad file.");
        state = obj;
        persist();
        alert("Imported!");
      } catch(e){
        alert("Could not import that file.");
      }
    };
    r.readAsText(f);
  }

  function resetAll(){
    if(!confirm("This will delete everything in the app. Continue?")) return;
    state = {characters:[],locations:[],threads:[],scenes:[]};
    persist();
  }

  function persist(){
    save(state);
    renderAll();
    refreshScenePickers();
  }

  function val(id){ return document.getElementById(id)?.value ?? ""; }
  function set(id, v){ const el=document.getElementById(id); if(el) el.value=v; }
  function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  // global search
  document.getElementById("globalSearch").addEventListener("input", (e)=>{
    const q = (e.target.value||"").toLowerCase().trim();
    if(!q){ renderAll(); return; }
    const hit = (txt)=> (txt||"").toLowerCase().includes(q);
    const results = [];
    state.characters.forEach(c=> { if(hit(c.name)||hit(c.notes)||hit(c.books)) results.push({k:"Character", t:c.name}); });
    state.locations.forEach(l=> { if(hit(l.name)||hit(l.notes)||hit(l.rules)) results.push({k:"Location", t:l.name}); });
    state.threads.forEach(t=> { if(hit(t.title)||hit(t.summary)||hit(t.books)) results.push({k:"Thread", t:t.title}); });
    state.scenes.forEach(s=> { if(hit(s.book)||hit(String(s.chapter))||hit(s.pov)||hit(s.beats)||hit(s.flags)) results.push({k:"Scene", t:`${s.book} Ch ${s.chapter||"?"}`}); });

    const box = document.getElementById("openThreadsList");
    box.innerHTML = `<div class="small muted">Search results:</div>`;
    const list = document.createElement("div"); list.className="list";
    results.slice(0,25).forEach(r=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML = `<div class="top"><div class="title">${escapeHtml(r.t)}</div><div class="small muted">${escapeHtml(r.k)}</div></div>`;
      list.appendChild(div);
    });
    box.appendChild(list);
  });

  // init
  function init(){
    if(!state.locations.length){
      state.locations.push({id:uid(), name:"(No location yet)", type:"Other", status:"Active", rules:"", notes:"", updatedAt:Date.now()});
      save(state);
    }
    refreshScenePickers();
    renderAll();
    set("s_book","Book 1");
  }
  init();
</script>
</body>
</html>
